---
title: "River Invertebrate Classification Tool (RICT) User Guide"
author: "RICT Steering Group"
date: "`r Sys.Date()`"
pkgdown:
  as_is: yes
output:
  rmarkdown::word_document:
    reference_docx: template.docx
    toc: yes
  rmarkdown::html_vignette:
    toc: yes
vignette: |
  %\VignetteIndexEntry{User Guide} \usepackage[utf8]{inputenc} %\VignetteEngine{knitr::rmarkdown}
editor_options:
  chunk_output_type: console
---

```{r results="asis", echo=FALSE, message=FALSE, warning=FALSE}
library(rict)
library(knitr)
# directly adding css to output html without ruining css style https://stackoverflow.com/questions/29291633/adding-custom-css-tags-to-an-rmarkdown-html-document
cat("
<style>
img {
border: 0px;
outline: 0 ;
}
</style>
")
``` 


![](images/rict_logo.png){ width=20% }

# Purpose 

Welcome to the RICT user guide! Here we explain how to upload macro-invertebrate results to [RICT website](https://rictapplications.shinyapps.io/rictapp/). Then demonstrate how to predict reference values for indices and taxa lists. Additionally, we explain how to classify status and compare results.

# Background

RICT uses data collected from sampling locations with minimal environmental
pressures to predict expected conditions across the river network. RICT
is used by the UK environment agencies to classify rivers for Water Framework
Directive (WFD) assessment, and provide a way of enforcing statutory objectives.

Key Functionality:
  
-	Predict reference indices values.
-	Predict reference taxa.
-	Classify the status of observed results compared to expected reference conditions.
-	Give a probability of status class.
-	Compare two samples and give a likelihood of whether they are significantly different.

# Quick Start

## Requirements

Before you start, you need data to process. If you do not have any data prepared, example data is provided in the  [validation template spreadsheet](). However, if you are looking to run your own results, you will need the following:

1. **WHPT scores** based on macro-invertebrate results. To calculate WHPT scores, you can use the [WHPT spreadsheet calculator](). Your scores should be based on macro-invertebrate results collected and analysed following [standard techniques](#sampling).

2. A list of **predictor values** based on field observations and GIS. Predictor values change depending on the geographic [area and model](#models-and-areas) you wish to use.

## Prepare Input File

1. [Download the validation template spreadsheet](), this provides a helpful template for your input file. For reference and testing, the template spreadsheet also includes example data.

2. Read the README instructions in the spreadsheet for guidance on completing the template.

2. Complete the template for the area required (GB - Great Britain. NI - Northern Ireland, IoM - Isle of Man) by adding in your WHPT results and predictor values.

4. Copy and paste the completed template with column names into a blank
spreadsheet and save as Comma Separated File (.CSV).

_NOTE - a template must contain data for only one region and model._

## Predict and Classify

1. Open the [RICT website](https://rictapplications.shinyapps.io/rictapp/),
select the [options](#options) you require.

2. Select 'Browse' button. Browse your files, upload the prepared .CSV
template file.

3. Depending on the [options](#options) you select, the following results will be displayed:

- Map with named site markers
  
- Download Outputs button
  
- Table of [validation](#validation) message (or a short message if all validation pass)
  
- Table of [predictions](#prediction)
  
- If [Classification](#classification) option selected, a table displaying Classification
  
- If [Predict Taxa Option](#taxa) selected, a table of predicted taxa

![Example of predict and classify section of the RICT website.](images/user-guide/rict-website.png){ width=90% }

4. If the process fails, the website displays a red error message. 

## Compare

1. Prepare two .CSV input files using spreadsheet template. Use the demo [up]() and [downstream]() files provided as a guide or to test out.

*NOTE: RICT compares the two files row to row. For instance, row 1 in the first file is compared to row 1 in the second file. Then row 2 is compared with row 2... and so on. Therefore, the two files being compared must contain the same number of rows.*

2. Open the [RICT website](https://rictapplications.shinyapps.io/rictapp/),
navigate to the Compare tab, select the options you require, for example
'single-year' or 'multi-year'.

3. Select 'Browse' button for file 1. Browse for your saved template file and upload. Repeat for file 2.

4. RICT will display your results. An error message will appear
if all your data failed validation. See the [Compare](#compare-results) section for more information on interpreting outputs.

![Example of the compare section of the RICT website.](images/user-guide/rict-website-compare.png){ width=90% }

## Options

![RICT options](images-user-guide/options.png)

### Year Type

- Single-year - processes data for separately for each year at each site. Classifies each season and combined Spring and Autumn, where data is available.
- Multi-year - aggregated outputs across multiple years for each site. Provides Spring and Autumn combined classification only.

See [Classification](#classification) for more details.

### Ouputs

Include [Classification](#classification) outputs and [predictions](#prediction), or only display predictions.

###	Include All Indices

This option will display predictions for all inverts indices not just WHPT predictions. RICT can predict around 60+ indices. See [All Indices](#indices) for more information. 

### Predict Taxa Lists

Display table of prediction for taxa list(s). See [taxa prediction](#taxa) for more information. 

# Validation

A number of checks and validations are automatically run once the input file is uploaded. RICT will detect and display any failures or warnings.

See the [Functional Specifications](/functional-specification.html#5-acceptance-and-validation-of-input-data) for the full list of checks, warnings and failure values.

# Usage

RICT is only suitable for freshwater (not estuarine or marine) sites on rivers
or streams that are naturally permanently flowing, and flow down to the sea (not
pumped).
  
For the official status classification, you must only classify sites that have
invertebrate data from both spring and autumn of the same year. You can only
perform a WFD macro-invertebrate classification using individual spring and
autumn values of WHPT ASPT and WHPT NTaxa (based on abundance-related index
values for all families at Taxon Level 2). The official method statement for the
river invertebrate (general degradation) classification is available from [WFD UKTAG](http://www.wfduk.org/resources/rivers-invertebrates-general-degradation).
  
The probabilities of class provided by RICT are only appropriate for samples
analysed in the laboratory and expressed in the correct form of WHPT to which
the bias values relate.
  
RICT classifications cannot be used for official purposes if based on single seasons, different forms of WHPT indices or samples not
analysed in the laboratory.

# Sampling

Collect and analyse all samples for RICT according to standard methods.
These two Environment Agency documents provide a current outline of the standard approach:

[LIT 11610 - Freshwater Macro-invertebrate Sampling in Rivers, 2017](https://www.fba.org.uk/s/LIT-11610-Freshwater-macro-invertebrate-sampling-in-rivers-09-12-2017.pdf)

[LIT 11614 - Freshwater Macro-invertebrate analysis of riverine samples, 2014](https://www.fba.org.uk/s/LIT-11614-Freshwater-macro-invertebrate-analysis-of-riverine-samples-28-Jan-2014.pdf)

More general guides are available on STAR project website: 

[http://www.eu-star.at/](http://www.eu-star.at/)

Enter > Protocols > Macro-invertebrates: RIVPACS Macro-invertebrate Sampling
Protocol (covers shallow water sampling only) and RIVPACS Sorting & Recording
(by Mike Furse).

# Prediction

RICT uses environmental predictors to model expected reference conditions. The model is called RIVPACS (River InVertebrate Prediction and Classification System). It is based on TWINSPAN grouping model. 

More information about the specification of the Models can be found in the
[Functional
Specifications](/functional-specification.html#5-acceptance-and-validation-of-input-data).

## Models and Areas

There are two models available in RICT:

1. Model 1 (with IoM, GB and NI variations)
- Based on a range of observed as well as physical/chemical predictors (substrate, river width, slope etc). Model 1 is the original predictive model, and this is still the definitive version, used for WFD river invertebrate status classification and objectives setting.
2. Model 44 (GB only)
- Based on GIS (geology, catchment size etc) and Alkalinity predictors using a new predictive model for GB only. This is a model new for testing and evaluation only.

The model is automatically selected based on the input template uploaded and the
area your grid references are located in.

## Envrionmental Predictors

Regardless of which season you want to predict, the environmental variables must
always be the median long-term averages that take account of conditions
throughout the whole year, including summer. Preferably they are based on annual
averages collected from many years. As a minimum, these averages should be based
on data collected in all three seasons (spring, summer and autumn) from at least
one normal year (not a year with drought or floods).
  
If you are unable to get such data, do not use actual measurements of width and
depth when you collected an invertebrate sample, particularly in summer, but use
your estimate what you think the normal width and depth should be and allow for
greater imprecision in RIVPACS predictions.
  
Environmental data from Environment Agency monitoring sites suitable for input
into RICT are available from the Ecology & Fish Data Explorer
https://environment.data.gov.uk/ecology-fish/.  This includes alkalinity and
discharge category.
  
### Discharge Category
  
Discharge category can be found using [Defra GIS wesbsite](https://environment.data.gov.uk/DefraDataDownload/?mapService=EA/RICT&mode-spatial). Additionally, GIS data for RIVPACS model 44 can also be downloaded.

### Alkalinity

Alkalinity (and its alternatives total hardness, calcium concentration or
conductivity) measured in Environment Agency chemical river quality monitoring
is also available from Open WIMS data and
http://eawaterquality.shinyapps.io/ecologicalstatsapp/.  The latter includes a
map interface for selecting sites.

## Indices

Indices simplify complex biological results to help ecologists explain them to
managers. Although their format is intentionally very simple (usually a single
number or letter), they are actually very complex, and most do not behave as
parameters on a continuous scale. Do not use indices as a basis for statistical
analysis.
  
Users should be wary of using indices, particularly without understanding the
extent of the data from which they were derived (comprehensiveness, reliability,
geographical and stream type coverage), the statistical properties of their
format (average, score, percentage), the impact of sampling and analytical error
on the index and the magnitude of that error, the way in which the environmental
pressure that the index is designed to respond affects invertebrates, other
environmental pressures that have the same effect, cause the same environmental
pressures or interact with each other (for example, reducing the availability of
oxygen, increasing siltation, altering the availability of metal ions or
nutrients), and other environmental pressures that co-occur at sites where the
pressure of interest occurs.
  
The fact that an index sensitive to a particular pressure indicates an impact
does not necessarily mean that pressure is present at a site.
  
Invertebrates respond to the integrated effect of all environmental
pressures (both natural and anthropogenic), and it is impossible to apportion
impact to individual pressures unless an environmental pressure is so severe
that it is overwhelming. This will increasingly be the case as gross pressures
are eliminated by environmental regulation.
  
Finally, the inclusion of an index in the RICT ‘all indices' prediction must not
be regarded as an endorsement of that index. Some indices have been included to
allow them to be evaluated or compared to other indices. Similarly, the
exclusion of an index does not imply that it is not useful.

**Add table**

## Taxa 

Predict the families and species expected at a site and their abundances. This
powerful feature of RIVPACS enables it to predict a wide range of
indices as well as helping with investigations to further our ecological
understanding.
  
Five taxa lists predicted at different levels of taxonomic resolution. 

- TL1 - Super-Family
- TL2 - Super and Family level
- TL3 - Family 
- Tl4 - Mainly species level
- TL5 - Family / Species level

Find more information about the taxa lists and their taxonomies in [WFD100 report]().

The website restricts the number of sites to no more than 24 sites due to the
large amount of processing and output generated for each site. Taxa prediction
may take several minutes to run depending on the number of sites and taxa lists
required.

If you select 'Prediction Only' then classification is not run,
therefore you do not need to include biological data in the input file.

###	Taxon Prediction Output

The results from the taxon taxa predictions include Maitland and Furse taxonomic
codes, some of which have leading zeroes. It you open the CSV output file with
Excel in the normal way, you will lose these leading zeroes because Excel will
assume that they are numbers. To preserve the leading zeroes when you open the
results in Excel, you will need to open a blank Excel worksheet and import the
results as text.

![Import csv as text into Excel using the Data tab](images/user-guide/taxa-download-excel-1.jpg){width=100%}
![Select comma separated, then 'Next'](images/user-guide/taxa-download-excel-2.jpg){width=100%}
![Click on maitland code column and select text, repeat for Furse Code. Click 'Finish'](images/user-guide/taxa-download-excel-3.jpg){width=100%}
![Click 'OK' (move the cursor to A1 if nesssary)](images/user-guide/taxa-download-excel-4.jpg){width=100%}
  
In the output, each row includes prediction results for one taxon. For each
site, expect about 3500 rows of data if predicting all taxa lists. The first
block of rows will be for the first site selected and below it the results for
the second site. For each site, rows are ordered by taxonomic level, then by
season code, and then by Maitland code, so you should re-order the data if you
only want data for a particular season but want that for all taxonomic levels.

Each row includes the following columns:

1. _siteName_ - provided in the input file.
2. _Model_  - 1 for RIVPACS IV Model 1 GB, 2 RIVPACS IV Model 1 NI.
3. _TL_ - Taxonomic level. The five levels (TL1 – TL5) are:

- TL1 = taxa recognised by BMWP indices
-	TL2 = taxa recognised by WHPT indices
-	TL3 = all families included in RIVPACS
-	TL4 = all species included in RIVPACS species
-	TL5 = mixed taxon level (a practical, mainly species level of analysis but with less easily recognised species identified to higher taxonomic levels)
  
4. _Season_Code_ Code specifying season; 1 = spring; 2 = summer; 3 = autumn.
  
5. _Maitland_Code_ - a code identifying the invertebrate.  Maitland codes are hierarchical.  The first two digits indicates class, the next two family, the next two genus and the final two species.  Codes with a letter are artificial combinations of taxa.
  
6. _Maitland_Name_ - name of the taxon represented by the Maitland code.

7. _Furse_Code_ - Updated Maitland code, revised by Mike Furse, 2 January 2007, useful for organising results into taxonomic order.

8. _Furse_Name_ - name of taxon represented by Furse code.

9. _NBN_Code_ - National Biodiversity Network code, compiled 2007

10. _NBN_Name_ - name of taxon represented by NBN code.

11. _Average_Numerical_Abundance_ - predicted numerical abundance based on average of 10,000 simulations

12. _Average_Log10_Abundance_ - predicted log10 abundance category, based on the average of 10.000 simulations

13. _Prob_Occurrence_ - predicted probability of the taxon being present

14. _Prob_Log1_ = probability of the taxon being present in log10 abundance category 1 (numerical abundance 1-9)

15. _Prob_Log2_ - probability of the taxon being present in log10 abundance category 2 (numerical abundance 10-99)

16. _Prob_Log3_ - probability of the taxon being present in log10 abundance category 3 (numerical abundance 100-999)

17. _Prob_Log4_ - probability of the taxon being present in log10 abundance category 4 (numerical abundance 1000-9999)

18. _Prob_Log5_ - probability of the taxon being present in log10 abundance category 5 (numerical abundance 10000+)
  
Further information about the taxonomic framework and the taxon prediction
output is given in
Davy-Bowker, J, R. Clarke, T. Corbin, H. Vincent, J. Pretty, A. Hawczak, J. Blackburn, J. Murphy & I. Jones (2008) River Invertebrate Classification Tool.  Final Report. SNIFFER Project WFD72c.  Edinburgh, SNIFFER

# Classification

The most important results from the classification reports are:

-	_Class_ – the WFD status.

-	_Probability of class_ – certainty of classification, taking account
of uncertainty caused by sampling and other errors.

-	ProbH, ProbG, ProbM, ProbP, ProbB – indicates other likely classes and whether your site is at the upper, mid or lower end of the class.

-	_EQR_ – Ecological Quality Ratio; The value of a biotic index expressed as a
proportion of its reference value. The reference value is what is expected at
minimally disturbed, near natural environmental quality.

A comparison of the EQRs for different indices and seasons can help you to
identify the environmental cause of poor quality.

## Single Year

This option undertakes status classifications for spring and autumn for a single
year. There is no difference in classification results if you run one years’
spring and summer data using the single year or the multi-year experiment.
However, there is a slight difference in the headers in the output file.

Single-year option also calculates single season classifications. Single season classification are intended only for investigative work. They are
unsuitable for setting environmental quality objectives or testing compliance
against them.

If you do not enter results for a season(s), RICT will leave the outputs for any missing season(s) empty.

### Single-Year Outputs

```{r, message=FALSE, echo=FALSE}
single_class <- rict(demo_observed_values[1, ], year_type = "single")
knitr::kable(t(single_class))
```

## Multi-year

The multi-year option combines data from spring and autumn from one or more years into a single classification for the site. There is no limit to the number
of years’ data that can be combined. Therefore, the multi-year experiment only gives
output for the combined years, not for each individual year.
  
There is a slight difference in the headers in the multi-year classification
output file compared to single year, as shown in the Section Description of RICT
classification output. There is no difference in classification results if you
run one years’ spring and summer data using the single year or the multi-year
experiment.
  
There are slight differences in the way that RICT estimates the probabilities of
class for multi-year classifications compared to previous versions of RICT.

The current RICT bases this on the proportion of all simulated multi-year
average EQR values falling in each status class, whereas RICT 1.0 used an
estimate of the “typical” (i.e., average) between-year variance within a 3-year
period for the observed values of a WHPT index to allow for 1 or 2 years missing
data. Neither is philosophically correct, as explained in the section about the
comparison of RICT and RICT2 and differences in classification results.

### Multi-Year Outputs

```{r, message=FALSE, echo=FALSE}
multi_class <- rict(demo_observed_values[1, ])
knitr::kable(t(multi_class))
```

## Probabilities of class

Probabilities of class indicate the likelihood of your site belonging to each of
the WFD status classes. Every site must belong to one of the 5-classes, so for
any combination of index and season(s), the probabilities always add-up to 100%.
These estimates take account of **two types of classification error**:

1. The fact that when the EQR is at exactly the class boundary, the maximum likelihood of being in either of the classes immediately above or below that boundary is only 50%.

2. Uncertainty caused by sampling error (measured in a number of studies in which the same site was sampled by different people at the same time) and laboratory error (from the bias value that you enter with your biological data).

The probabilities are based on the frequency if each class being indicated by
the 10,000 Monte Carlo simulations. Each simulation includes a random component
with the same distribution as the known bias and sampling error. Remember that
other sources of error mentioned in this section, which cannot be qualified,
will also contribute to the imprecision of the classification.

## MINTA (Minimum of NTaxa and ASPT)

The official Water Framework Directive (WFD) status classification is based on
data (Environmental Quality Ratios) for both WHPT ASPT and WHPT NTaxa from both
spring and autumn. Data from both seasons is combined by taking an average of
the EQRs before determining the status classification. The status classification
from both indices is combined by taking the worst class indicated by the two
indices. MINTA is not determined from the most probable classes for each index,
but by the combination of the probabilities of class for each index.
  
Understanding how the probabilities of class are determined for MINTA is often
misunderstood, particularly as the outcome is sometimes counter-intuitive and
has caused users, including the author, to assume that there has been a mistake.
MINTA probabilities of class are not calculated from the distribution of
probabilities of the individual indices.
  
They are calculated separately, in exactly the same way as the probabilities of
class for the individual indices, by going back to the results of each of the
10,000 Monte Carlo simulations. The MINTA probabilities are based on the worst
class indicated by either ASPT or NTaxa in each of the 10,000 Monte Carlo
simulations.
  
The number of simulations in which the worst of these classes was High, Good,
Moderate, Poor or Bad are summed and expressed as percentages of the 10,000
simulations.  This is the same process used to determine the probabilities of
class for the individual indices, but this time, for each simulation RICT only
considers the class indicated by the index that indicated the worst class.

## Interpreting Classification Output 

Classification is based on both your observed data and RIVPACS prediction, so
you must consider imprecision in both of these when interpreting classification
results. You must take account of the reliability of the predictions, see
Section Interpreting RICT2 prediction output.
   
Always check the suitability code from the prediction results, which is based on
the combination of environmental input variables and how closely they match any
of the RIVPACS end groups. Suitability is quite different to the probability of
class, which does not take suitability into account.
  
You should also consider any environmental parameters that exceed warning limit
values when judging the reliability of the predictions and therefore of the
classification. Another factor is the quality of the input data: whether the
environmental data is based on true long-term averages or an estimate base on
biologist’s expert opinion.
  
For classification, the quality of the observed biological data is also
important. This is partly reflected in the bias value, which represents a
component of sorting and data handling error. You should also consider whether
the biologist collecting the samples collected them correctly, or experienced
anything that made sampling difficult, such as high or low flow, poor access to
the site, damaged nets, declining light or turbid water, which should be
recorded with the sample data. Always consider the probabilities of class and do
not base management decisions solely on the face value or most probable class.
  
A site with an objective quality of Good that is classed as Moderate is less
likely to have failed that standard if it also has a reasonably high probability
of being good or better, and may not have actually failed the standard, whereas
a site classed as Moderate but with high probabilities of being Poor or Bad is
more likely to have failed the standard and the need for management action is
much more certain. Remember that probabilities do not always behave intuitively,
as shown in the explanation of MINTA in the preceding Section.
  
Two examples below illustrate how the result can be counter-intuitive.
  
Site A The most probable class of both ASPT and NTaxa are the same, Good, but MINTA indicated Moderate. Many of the simulations in which the worst class was indicated as Moderate by ASPT were different to the simulations where this was the worst class indicated as Moderate by NTaxa. As a result, when the number of simulations in which Moderate was indicated by ASPT and by NTaxa were added together, it came to a greater number than for each individual index, hence Moderate was the most probable MINTA class even though the most probable class for both indices individually was Good. It’s not uncommon for the MINTA most probable class to be worse that the most probable classes indicated by either ASPT or NTaxa separately.
  
Site B The most probable class indicated by ASPT and NTaxa were different, but MINTA indicated an even worse class. A similar thing happened here as at Site A, but more extreme. Some of the simulations in which Bad was indicated by ASPT were different to the simulations in which Bad was indicated by NTaxa, so when combined, more simulations were Bad according to MINTA than any other class.
At Site A, the probability of the MINTA class being Good and Moderate are similar, and at Site B there is little difference in the probabilities of the MINTA class being poor or bad.  This indicates the importance of using the probabilities of class to make decisions rather than simply the face value class or even the most probable class.

# Compare Results

Compare allows you to run a comparison between two 
sites or the same site at different times. The outputs consist of ASPT & NTAXA EQRs and their difference statistics. Probabilities of sites being different and probabilities of each site class combination are also given.

# Contributing

The RICT code is available as open-source R package available on github. If you
wish to customise the workflow or run large dataset, it may be useful to run the
code on your local machine. You can download the [package from
Github](https://github.com/aquaMetrics/rict) for this purpose. For contributing
to the code, please see [contributing
guidelines](https://github.com/aquaMetrics/rict/blob/master/CONTRIBUTING.md).

# Troubleshooting

This section describes some common issues that can cause the tool to fail.

### Re-run
Sometimes, the website can fail the first time that you run it. Before checking anything else, always reload, to see if it runs on a second attempt. These unexplained failures, possibly caused by a data transfer drop-out somewhere along the line, are the common causes of app failing to run.

###	Use Correct Validation Input File
The latest input file can be obtained from the RICT site. Ensure you have downloaded the correct version of the input file.

###	Check Input File is in Correct Format
Once you have entered the data into the Excel (xls) file, the input file must be saved in CSV (comma delimited) file format only. Other formats will not be processed by RICT. Other formats may not be able to be uploaded or the tool may not run.

###	Remove Empty or Null Lines Within Input File
Any empty lines at the end of the input file may cause RICT to fail. Ensure the last line of the input file is the last site you have submitted. Blank lines, or lines of commas may cause RICT to fail.

###	Remove Red Validation Fails from the Input File
When using the validation spreadsheet any cells with values above/below the tolerances/ranges will show as red in the spreadsheet. These sites may fail the whole run therefore remove these sites from the input file.

###	Site Not Appearing in the Output
If a site is included in the input file but it is not appearing in the output file, it is likely that some of the inputted data exceeds the failure tolerances.
To check validations output to see if this is the case.

### Errors

Common error messages and cause:

Error             | Known Cause
-------------     | -------------
The data provided contains more than one area of the UK. Hint: Check your data contains NGR grid letters for either: GB or NI | Row of blank data at the end of the input file
Arguments imply differing number of rows  | Season code missing from input file Grid reference in the sea so no temperature (can be caused by 4-figure easting and/or northing)
Argument is of length zero | Temperature data missing because grid reference in the sea or too close to the shore

### Check the Grid Reference
 
Incorrect grid references are a common cause of problems, particularly if they
are in the sea. RICT uses the grid references to extract mean air temperature
and temperature range from an internal data file, but the temperature data that
RICT uses only covers the land. The temperature data does not reach as far as
the sea, so sites close to the coast can also fail. If such sites fail, you
should use a slightly more inland grid reference.
  
Leading zeroes may be omitted because the CSV input file ignores them, but
trailing zeroes must be included. Eastings and northings for fully numerical
grid references (without NGR letters) should not be used.

###	RICT Project Info

The RICT project website contains all the background documentation for RICT. The
RICT site can be accessed by visiting:
https://www.fba.org.uk/other-scientific-collaborations/rivpacs-and-rict




